!function(t){var e={};function n(o){if(e[o])return e[o].exports;var i=e[o]={i:o,l:!1,exports:{}};return t[o].call(i.exports,i,i.exports,n),i.l=!0,i.exports}n.m=t,n.c=e,n.d=function(t,e,o){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:o})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var o=Object.create(null);if(n.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)n.d(o,i,function(e){return t[e]}.bind(null,i));return o},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s=4)}([function(t,e,n){"use strict";var o=this&&this.__awaiter||function(t,e,n,o){return new(n||(n=Promise))((function(i,r){function s(t){try{c(o.next(t))}catch(t){r(t)}}function a(t){try{c(o.throw(t))}catch(t){r(t)}}function c(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}c((o=o.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const i=n(3);e.default=class{constructor(t,e="eu"){this.appID=t,this.server=e,this.serialize=function(t){let e=[];for(let n in t)t.hasOwnProperty(n)&&e.push(encodeURIComponent(n)+"="+encodeURIComponent(t[n]));return e.join("&")}}call(t,e){return o(this,void 0,void 0,(function*(){e.application_id=this.appID;const n=this.serialize(e),o=`https://api.worldoftanks.${this.server}/wot/${t}/?${n}`;return console.log(o),yield(yield i.default(o)).json()}))}}},function(t,e){t.exports=require("express")},function(t,e,n){"use strict";function o(t,e){e.json({type:"error",message:t})}Object.defineProperty(e,"__esModule",{value:!0}),e.default=o,e.asyn=function(t){return function(e,n){t(e,n).catch(t=>{t.errno&&t.sqlMessage?o(`SQL ERROR ${t.errno} : ${t.sqlMessage}`,n):o(t,n)})}}},function(t,e){t.exports=require("node-fetch")},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const o=n(5),i=n(1),r=n(6);o.config();const s=n(7),a=n(2),{APP_BASE_URL:c="/",PORT:u=8080,NODE_ENV:d="development"}=process.env,l=i();l.set("view engine","ejs"),l.use(r),l.set("views","public/"),l.use(c,i.static("public")),l.use(c+"api",s.API),l.get(c,(t,e)=>{e.render("index")}),l.get(c+":user_id",(t,e)=>{e.render("stats",{params:t.params})}),l.listen(u,()=>console.log("Server started at "+(new Date).toString())),l.use((t,e,n,o)=>{a.default(t.message,n)})},function(t,e){t.exports=require("dotenv")},function(t,e){t.exports=require("express-force-https")},function(t,e,n){"use strict";var o=this&&this.__awaiter||function(t,e,n,o){return new(n||(n=Promise))((function(i,r){function s(t){try{c(o.next(t))}catch(t){r(t)}}function a(t){try{c(o.throw(t))}catch(t){r(t)}}function c(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}c((o=o.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const i=n(1),r=n(8),s=n(2),a=n(9),c=n(3),u=n(12);e.API=i.Router();const d=new a.default(process.env.APPID,"eu");e.API.get("/player/:name",s.asyn((t,e)=>o(void 0,void 0,void 0,(function*(){e.json(yield d.accounts.search(t.params.name))})))),e.API.get("/player/:player_id/info",s.asyn((t,e)=>o(void 0,void 0,void 0,(function*(){e.json(yield d.accounts.info(t.params.player_id))})))),e.API.get("/player/:player_id/tanks_stats",s.asyn((t,e)=>o(void 0,void 0,void 0,(function*(){e.json(yield d.tanks.stats(t.params.player_id))})))),e.API.get("/update-expected",s.asyn((t,e)=>o(void 0,void 0,void 0,(function*(){const t=yield(yield c.default("https://static.modxvm.com/wn8-data-exp/json/wn8exp.json")).json();let n={};t.data.forEach(t=>{n[t.IDNum]=t}),r.writeFileSync("data/exp.json",JSON.stringify(n)),e.send("done")})))),e.API.get("/update-tanks",s.asyn((t,e)=>o(void 0,void 0,void 0,(function*(){const t=yield d.tanks.getAll();r.writeFileSync("data/tanks.json",JSON.stringify(t)),e.send("done")})))),e.API.use("/tanks",i.static("data/tanks.json")),e.API.use("/expected",i.static("data/exp.json")),e.API.get("/player/:player_id/data",s.asyn((t,e)=>o(void 0,void 0,void 0,(function*(){const n=t.params.player_id;console.log("Player data asked for "+n);const o=yield d.accounts.info(n);if(!(null==o?void 0:o.data[n]))throw"Fatal error while loading the user";const i=o.data[n];let r=[];const s=(yield u.database.query("SELECT * FROM snapshots WHERE pid = ? AND time = ?",[n,i.updated_at.toString()]))[0];if(s)e.json({player:i,tanks_stats:(yield u.database.query("SELECT * FROM snapshots_data WHERE id = ?",[s.id])).map(t=>JSON.parse(t.data))});else{const t=(yield d.tanks.stats(n)).data[n].map(t=>Object.assign({tank_id:t.tank_id},t.all));r=t,e.json({player:i,tanks_stats:r});const o=(yield u.database.query("INSERT INTO snapshots VALUES (NULL, ?, ?)",[n,i.updated_at.toString()])).insertId;t.forEach(t=>u.database.query("INSERT INTO snapshots_data VALUES (?, ?, ?)",[o.toString(),t.tank_id,JSON.stringify(t)])),console.log("done")}}))))},function(t,e){t.exports=require("fs")},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const o=n(0),i=n(10),r=n(11);class s extends o.default{constructor(t,e="eu"){super(t,e),this.accounts=new i.default(t,e),this.tanks=new r.default(t,e)}}e.default=s},function(t,e,n){"use strict";var o=this&&this.__awaiter||function(t,e,n,o){return new(n||(n=Promise))((function(i,r){function s(t){try{c(o.next(t))}catch(t){r(t)}}function a(t){try{c(o.throw(t))}catch(t){r(t)}}function c(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}c((o=o.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const i=n(0);class r extends i.default{search(t){return o(this,void 0,void 0,(function*(){return yield this.call("account/list",{search:t})}))}info(t,e="account_id, nickname, updated_at, statistics.all, created_at, logout_at, last_battle_time"){return o(this,void 0,void 0,(function*(){return yield this.call("account/info",{account_id:t,fields:e})}))}}e.default=r},function(t,e,n){"use strict";var o=this&&this.__awaiter||function(t,e,n,o){return new(n||(n=Promise))((function(i,r){function s(t){try{c(o.next(t))}catch(t){r(t)}}function a(t){try{c(o.throw(t))}catch(t){r(t)}}function c(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}c((o=o.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const i=n(0);class r extends i.default{stats(t){return o(this,void 0,void 0,(function*(){return yield this.call("tanks/stats",{account_id:t,fields:"all, tank_id"})}))}getAll(){return o(this,void 0,void 0,(function*(){return(yield this.call("encyclopedia/vehicles",{fields:"is_premium, images.small_icon, name, tier"})).data}))}}e.default=r},function(t,e,n){"use strict";var o=this&&this.__awaiter||function(t,e,n,o){return new(n||(n=Promise))((function(i,r){function s(t){try{c(o.next(t))}catch(t){r(t)}}function a(t){try{c(o.throw(t))}catch(t){r(t)}}function c(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}c((o=o.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const i=n(13);class r{constructor(){this._output_errors=!process.env.ERRORS||"1"==process.env.ERRORS}get connection(){return this._con||(this._con=i.createConnection({host:process.env.DB_HOST||"localhost",user:process.env.DB_USER||"root",password:process.env.DB_PSSWD||"",database:process.env.DB_NAME||"wn8master",charset:"utf8mb4_unicode_ci"})),this._con}query(t,e=[]){return o(this,void 0,void 0,(function*(){return new Promise((n,o)=>{this.connection.query(t,e,(t,e)=>{t&&(this._output_errors?o(t):o("Database error")),n(e)})})}))}beginTransaction(){return o(this,void 0,void 0,(function*(){return new Promise((t,e)=>{this.connection.beginTransaction(n=>{n&&(this._output_errors?e(n):e("Database error")),t()})})}))}commit(){return o(this,void 0,void 0,(function*(){return new Promise((t,e)=>{this.connection.commit(n=>{n&&(this._output_errors?e(n):e("Database error")),t()})})}))}rollback(){return o(this,void 0,void 0,(function*(){return new Promise((t,e)=>{this.connection.rollback(n=>{n&&(this._output_errors?e(n):e("Database error")),t()})})}))}end(){return new Promise((t,e)=>{this.connection.end(n=>{n&&(this._output_errors?e(n):e("Database error")),t()})})}}e.db=r,e.database=new r},function(t,e){t.exports=require("mysql")}]);