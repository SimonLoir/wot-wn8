!function(e){var t={};function n(a){if(t[a])return t[a].exports;var s=t[a]={i:a,l:!1,exports:{}};return e[a].call(s.exports,s,s.exports,n),s.l=!0,s.exports}n.m=e,n.c=t,n.d=function(e,t,a){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:a})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var a=Object.create(null);if(n.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)n.d(a,s,function(t){return e[t]}.bind(null,s));return a},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=4)}([function(e,t,n){"use strict";var a=this&&this.__awaiter||function(e,t,n,a){return new(n||(n=Promise))((function(s,o){function i(e){try{c(a.next(e))}catch(e){o(e)}}function r(e){try{c(a.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,r)}c((a=a.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const s=n(3);t.default=class{constructor(e,t="eu"){this.appID=e,this.server=t,this.serialize=function(e){let t=[];for(let n in e)e.hasOwnProperty(n)&&t.push(encodeURIComponent(n)+"="+encodeURIComponent(e[n]));return t.join("&")}}call(e,t){return a(this,void 0,void 0,(function*(){t.application_id=this.appID;const n=this.serialize(t),a=`https://api.worldoftanks.${this.server}/wot/${e}/?${n}`;return console.log(a),yield(yield s.default(a)).json()}))}}},function(e,t){e.exports=require("express")},function(e,t,n){"use strict";function a(e,t){t.status(500).json({type:"error",message:e})}Object.defineProperty(t,"__esModule",{value:!0}),t.default=a,t.asyn=function(e){return function(t,n){e(t,n).catch(e=>{e.errno&&e.sqlMessage?a(`SQL ERROR ${e.errno} : ${e.sqlMessage}`,n):a(e,n)})}}},function(e,t){e.exports=require("node-fetch")},function(e,t,n){"use strict";var a=this&&this.__awaiter||function(e,t,n,a){return new(n||(n=Promise))((function(s,o){function i(e){try{c(a.next(e))}catch(e){o(e)}}function r(e){try{c(a.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,r)}c((a=a.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const s=n(9),o=n(5),i=n(1),r=n(6),c=n(7);o.config();const u=n(8),d=n(2),l=n(13),p=n(15),{APP_BASE_URL:f="/",PORT:h=8080,NODE_ENV:_="development"}=process.env,y=i();if(y.set("view engine","ejs"),y.use(r),y.set("views","public/"),y.use(f,i.static("public")),y.use(f+"api",u.API),y.get(f,(e,t)=>{t.render("index")}),y.get(f+":user_id",(e,t)=>{t.render("stats",{params:e.params})}),y.get(f+":user_id/:tank_id",(e,t)=>{t.render("tanks",{params:e.params})}),y.listen(h,()=>console.log("Server started at "+(new Date).toString())),y.use((e,t,n,a)=>{d.default(e.message,n)}),process.env.DISCORD_TOKEN){const e=new c.Client;e.login(process.env.DISCORD_TOKEN),e.on("message",e=>a(void 0,void 0,void 0,(function*(){let t=e.content;if(0==t.indexOf("!wn ")&&(t=t.replace("!wn ",""),0==t.indexOf("search "))){const n=t.replace("search ","").trim(),a=yield l.database.query("SELECT * FROM users WHERE user_name = ?",[n]);if(1!=a.length)return e.channel.send("Could not find the user, it may not be indexed in our database yet.");const{user_id:o,user_name:i}=a[0],r=yield l.database.query("SELECT * FROM snapshots WHERE pid = ? ORDER BY id DESC LIMIT 1",[o]),u="https://wn8master.games/"+o;if(1!=r.length)return e.channel.send(`No snapshot found ! \nVisit ${u} to create one :-)`);const d=JSON.parse(s.readFileSync("data/exp.json","utf8")),f=(yield l.database.query("SELECT * FROM snapshots_data WHERE id = ?",[r[0].id])).map(e=>JSON.parse(e.data)),h={IDNum:0,expDef:0,expFrag:0,expSpot:0,expDamage:0,expWinRate:0},_={damage_dealt:0,spotted:0,frags:0,dropped_capture_points:0,wins:0,battles:0};console.time("Compute duration"),f.forEach(e=>{_.damage_dealt+=e.damage_dealt,_.spotted+=e.spotted,_.frags+=e.frags,_.dropped_capture_points+=e.dropped_capture_points,_.wins+=e.wins,_.battles+=e.battles;e.damage_dealt,e.battles,e.xp,e.battles,e.spotted,e.battles,e.frags,e.battles,e.dropped_capture_points,e.battles,e.wins,e.wins,e.draws,e.losses;let t;try{const t=d[e.tank_id];h.expDamage+=e.battles*t.expDamage,h.expDef+=e.battles*t.expDef,h.expFrag+=e.battles*t.expFrag,h.expSpot+=e.battles*t.expSpot,h.expWinRate+=.01*e.battles*t.expWinRate}catch(e){t=-1}});const y=_.damage_dealt/h.expDamage,v=_.spotted/h.expSpot,m=_.frags/h.expFrag,g=_.dropped_capture_points/h.expDef,x=_.wins/h.expWinRate,b=p.wn8(y,v,m,g,x);console.timeEnd("Compute duration");const E=new c.MessageEmbed;E.setTitle(i),E.setDescription(`Username : ${i} #${o}\n            Last update : ${r[0].date}\n            WN8 : ${b.toFixed(2)}\n            Battles : ${_.battles}\n\n            Link to update : ${u}\n            `),E.setColor(p.getColor(b,!1)),e.channel.send(E)}})))}},function(e,t){e.exports=require("dotenv")},function(e,t){e.exports=require("express-force-https")},function(e,t){e.exports=require("discord.js")},function(e,t,n){"use strict";var a=this&&this.__awaiter||function(e,t,n,a){return new(n||(n=Promise))((function(s,o){function i(e){try{c(a.next(e))}catch(e){o(e)}}function r(e){try{c(a.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,r)}c((a=a.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const s=n(1),o=n(9),i=n(2),r=n(10),c=n(3),u=n(13);t.API=s.Router();const d=new r.default(process.env.APPID,"eu");t.API.get("/player/:name",i.asyn((e,t)=>a(void 0,void 0,void 0,(function*(){const n=yield d.accounts.search(e.params.name);t.json(n),n.data.forEach(e=>a(void 0,void 0,void 0,(function*(){const{account_id:t,nickname:n}=e;yield u.database.query("INSERT INTO users VALUES (?, ?) ON DUPLICATE KEY UPDATE user_name = ?",[t.toString(),n,n])})))})))),t.API.get("/player/:name/search",i.asyn((e,t)=>a(void 0,void 0,void 0,(function*(){if(e.params.name.length<3)throw"Too few chars, could not perform the request";t.json(yield u.database.query("SELECT * FROM users WHERE user_name LIKE ?",["%"+e.params.name+"%"]))})))),t.API.get("/update-expected",i.asyn((e,t)=>a(void 0,void 0,void 0,(function*(){const e=yield(yield c.default("https://static.modxvm.com/wn8-data-exp/json/wn8exp.json")).json();let n={};e.data.forEach(e=>{n[e.IDNum]=e}),o.writeFileSync("data/exp.json",JSON.stringify(n)),t.send("done")})))),t.API.get("/update-tanks",i.asyn((e,t)=>a(void 0,void 0,void 0,(function*(){const e=yield d.tanks.getAll();o.writeFileSync("data/tanks.json",JSON.stringify(e)),t.send("done")})))),t.API.use("/tanks",s.static("data/tanks.json")),t.API.use("/expected",s.static("data/exp.json")),t.API.get("/player/:player_id/data",i.asyn((e,t)=>a(void 0,void 0,void 0,(function*(){const n=e.params.player_id;console.log("Player data asked for "+n);const a=yield d.accounts.info(n);if(!(null==a?void 0:a.data[n]))throw"Fatal error while loading the user";const s=a.data[n];const o=(yield u.database.query("SELECT * FROM snapshots WHERE pid = ? AND time = ?",[n,s.updated_at.toString()]))[0];if(o)t.json({player:s,tanks_stats:(yield u.database.query("SELECT * FROM snapshots_data WHERE id = ?",[o.id])).map(e=>JSON.parse(e.data))});else{const e=(yield d.tanks.stats(n)).data[n].map(e=>Object.assign({tank_id:e.tank_id},e.all));t.json({player:s,tanks_stats:e});try{const t=(yield u.database.query("INSERT INTO snapshots VALUES (NULL, ?, ?, ?)",[n,s.updated_at.toString(),new Date(1e3*s.updated_at).toISOString().split("T")[0]])).insertId;e.forEach(e=>u.database.query("INSERT INTO snapshots_data VALUES (?, ?, ?)",[t.toString(),e.tank_id,JSON.stringify(e)]))}catch(e){console.log(e)}}})))),t.API.get("/player/:player_id/snapshots",i.asyn((e,t)=>a(void 0,void 0,void 0,(function*(){t.json(yield u.database.query("SELECT * FROM \n                snapshots_data s\n                WHERE s.id IN (\n                SELECT MAX(id) AS id\n                FROM snapshots \n                WHERE pid = ?\n                GROUP BY `date`)",[e.params.player_id]))})))),t.API.get("/player/:player_id/available_snapshots",i.asyn((e,t)=>a(void 0,void 0,void 0,(function*(){t.json(yield u.database.query("SELECT id, time\n                FROM snapshots \n                WHERE pid = ?",[e.params.player_id]))})))),t.API.get("/player/:player_id/tank/:tank_id/snapshots/:from/:to",i.asyn((e,t)=>a(void 0,void 0,void 0,(function*(){t.json((yield u.database.query("SELECT * FROM snapshots_data sd, snapshots s \n                    WHERE \n                    sd.id = s.id\n                    AND s.pid = ?\n                    AND tank_id = ?\n                    AND s.id >= ?\n                    AND s.id <= ?",[e.params.player_id,e.params.tank_id,e.params.from,e.params.to])).map(e=>{let t=JSON.parse(e.data);return t.time=e.time,t}))}))))},function(e,t){e.exports=require("fs")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const a=n(0),s=n(11),o=n(12);class i extends a.default{constructor(e,t="eu"){super(e,t),this.accounts=new s.default(e,t),this.tanks=new o.default(e,t)}}t.default=i},function(e,t,n){"use strict";var a=this&&this.__awaiter||function(e,t,n,a){return new(n||(n=Promise))((function(s,o){function i(e){try{c(a.next(e))}catch(e){o(e)}}function r(e){try{c(a.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,r)}c((a=a.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const s=n(0);class o extends s.default{search(e){return a(this,void 0,void 0,(function*(){return yield this.call("account/list",{search:e})}))}info(e,t="account_id, nickname, updated_at, statistics.all, created_at, logout_at, last_battle_time"){return a(this,void 0,void 0,(function*(){return yield this.call("account/info",{account_id:e,fields:t})}))}}t.default=o},function(e,t,n){"use strict";var a=this&&this.__awaiter||function(e,t,n,a){return new(n||(n=Promise))((function(s,o){function i(e){try{c(a.next(e))}catch(e){o(e)}}function r(e){try{c(a.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,r)}c((a=a.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const s=n(0);class o extends s.default{stats(e){return a(this,void 0,void 0,(function*(){return yield this.call("tanks/stats",{account_id:e,fields:"all, tank_id"})}))}getAll(){return a(this,void 0,void 0,(function*(){return(yield this.call("encyclopedia/vehicles",{fields:"is_premium, images.small_icon, name, tier"})).data}))}}t.default=o},function(e,t,n){"use strict";var a=this&&this.__awaiter||function(e,t,n,a){return new(n||(n=Promise))((function(s,o){function i(e){try{c(a.next(e))}catch(e){o(e)}}function r(e){try{c(a.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,r)}c((a=a.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const s=n(14);class o{constructor(){this._output_errors=!process.env.ERRORS||"1"==process.env.ERRORS}get connection(){return this._con||(this._con=s.createConnection({host:process.env.DB_HOST||"localhost",user:process.env.DB_USER||"root",password:process.env.DB_PSSWD||"",database:process.env.DB_NAME||"wn8master",charset:"utf8mb4_unicode_ci"})),this._con}query(e,t=[]){return a(this,void 0,void 0,(function*(){return new Promise((n,a)=>{this.connection.query(e,t,(e,t)=>{e&&(this._output_errors?a(e):a("Database error")),n(t)})})}))}beginTransaction(){return a(this,void 0,void 0,(function*(){return new Promise((e,t)=>{this.connection.beginTransaction(n=>{n&&(this._output_errors?t(n):t("Database error")),e()})})}))}commit(){return a(this,void 0,void 0,(function*(){return new Promise((e,t)=>{this.connection.commit(n=>{n&&(this._output_errors?t(n):t("Database error")),e()})})}))}rollback(){return a(this,void 0,void 0,(function*(){return new Promise((e,t)=>{this.connection.rollback(n=>{n&&(this._output_errors?t(n):t("Database error")),e()})})}))}end(){return new Promise((e,t)=>{this.connection.end(n=>{n&&(this._output_errors?t(n):t("Database error")),e()})})}}t.db=o,t.database=new o},function(e,t){e.exports=require("mysql")},function(e,t,n){"use strict";function a(e,t,n,a,s){const o=Math.max(0,(s-.71)/(1-.71)),i=Math.max(0,(e-.22)/.78),r=Math.max(0,Math.min(i+.2,(n-.12)/.88));return 980*i+210*i*r+155*r*Math.max(0,Math.min(i+.1,(t-.38)/.62))+75*Math.max(0,Math.min(i+.1,(a-.1)/.9))*r+145*Math.min(1.8,o)}Object.defineProperty(t,"__esModule",{value:!0}),t.computeWN8=function(e,t,n,s,o,i){return a(e/i.expDamage,t/i.expSpot,n/i.expFrag,s/i.expDef,o/i.expWinRate)},t.wn8=a,t.getColor=function(e,t=!0){let n=[90,49,117];return e<300?n=[0,0,0]:e<599?n=[205,51,51]:e<899?n=[215,121,0]:e<1249?n=[215,182,0]:e<1599?n=[109,149,33]:e<1899?n=[76,118,46]:e<2349?n=[74,146,183]:e<2899&&(n=[131,87,157]),t?`rgb(${n[0]}, ${n[1]}, ${n[2]})`:n}}]);